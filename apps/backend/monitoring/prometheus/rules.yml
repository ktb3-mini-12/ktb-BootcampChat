# Prometheus Recording Rules
# 컨테이너 메트릭은 cAdvisor의 name 레이블을 직접 사용
# (Docker container_name 레이블이 자동으로 제공됨)

groups:
  - name: container_metrics
    interval: 30s
    rules:
      # CPU 사용률 (%)
      - record: container_cpu_usage_rate
        expr: |
          rate(container_cpu_usage_seconds_total{name!=""}[5m]) * 100

      # 메모리 사용량 (bytes)
      - record: container_memory_usage_bytes
        expr: |
          container_memory_working_set_bytes{name!=""}

      # 네트워크 수신 속도 (bytes/s)
      - record: container_network_receive_bytes_rate
        expr: |
          rate(container_network_receive_bytes_total{name!=""}[5m])

      # 네트워크 송신 속도 (bytes/s)
      - record: container_network_transmit_bytes_rate
        expr: |
          rate(container_network_transmit_bytes_total{name!=""}[5m])

      # 디스크 읽기 속도 (bytes/s)
      - record: container_fs_reads_bytes_rate
        expr: |
          rate(container_fs_reads_bytes_total{name!=""}[5m])

      # 디스크 쓰기 속도 (bytes/s)
      - record: container_fs_writes_bytes_rate
        expr: |
          rate(container_fs_writes_bytes_total{name!=""}[5m])

  - name: alerts
    rules:
      # 컨테이너 다운 알림
      - alert: ContainerDown
        expr: absent(container_last_seen{name=~"mongo-ktb|redis-ktb|prometheus-ktb|grafana-ktb"})
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "컨테이너가 다운되었습니다"
          description: "{{ $labels.name }} 컨테이너가 1분 이상 응답하지 않습니다."

      # 높은 CPU 사용률 알림
      - alert: HighCpuUsage
        expr: container_cpu_usage_rate > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "높은 CPU 사용률"
          description: "{{ $labels.name }} 컨테이너의 CPU 사용률이 80%를 초과했습니다."

      # 높은 메모리 사용률 알림
      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "높은 메모리 사용률"
          description: "{{ $labels.name }} 컨테이너의 메모리 사용률이 80%를 초과했습니다."
